<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>video录制</title>
    <style>
        #container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .controls {
            padding:0 10px;
        }
    </style>
</head>

<body>
    <div class="layui-body">
        <div id="container">
            <video id="gum" autoplay muted></video>
            <div class="controls">
                <button id="record" disabled>开始录制</button>
                <button id="play" disabled>播放</button>
                <span id="tEl"></span>
            </div>
            <video id="gum2" controls="controls" autoplay style="display:none"></video>
        </div>
    </div>
</body>
<script>
    class RecordingVideo {
        // 播放时长
        duration = 0
        // 录制流媒体
        mediaRecorder
        // 录制的数据
        recordedBlobs
        // 倒计时interlval
        intervalId
        // 摄像头流媒体
        stream
        // 录制时长
        maxD = 15
        // 倒计时初始值
        count = 15
        // 页面dom
        gumVideo = document.querySelector('#gum')
        gumVideo2 = document.querySelector('#gum2')
        recordButton = document.querySelector('#record')
        playButton = document.querySelector('#play')
        tEL = document.getElementById('tEl')
        constructor() {
            const constraints = {
                audio: true,
                video: {
                    facingMode: "user",
                    width: 400,//视频宽度
                    height: 400,//视频高度
                    frameRate: 60,//每秒60帧
                }
            }
            this.init()
            this.recordButton.onclick = () => this.toggleRecording()
            this.playButton.onclick = () => this.play()
            this.gumVideo2.width = constraints.video.width
            this.gumVideo2.height = constraints.video.height
            this.getUserMedia(constraints,(e) => this.handleSuccess(e),(e) => this.handleError(e))
            
        }
        // 初始化
        init() {
            if (typeof MediaSource === 'undefined') {
                alert('你的手机不支持该功能')
            } 
            const mediaSource = new MediaSource()
            mediaSource.addEventListener('sourceopen', e => this.handleSourceOpen(e), false)

            const isSecureOrigin = location.protocol === 'https:' || location.hostname === 'localhost'
            if (!isSecureOrigin) {
                alert('getUserMedia() 必须在https或localhost下使用')
                location.protocol = 'HTTPS'
            }
        }
        // 设置视频的source
        handleSourceOpen(event) {
            mediaSource.addSourceBuffer('video/webm; codecs="vp8"')
        }
        // 开始录制的事件
        toggleRecording() {
            const tEl = this.tEL
            if (this.recordButton.textContent === '开始录制') {
                tEl.innerHTML = ''
                this.startRecording()
                clearInterval(this.intervalId)
                tEl.innerHTML = '剩余时间：'+this.count+'秒'
                this.intervalId = setInterval(()  => {
                    tEl.innerHTML = '剩余时间：'+this.count+'秒'
                    if (this.count <= 0) {
                        clearInterval(intervalId)
                        this.duration = this.maxD - this.count
                        this.count = this.maxD
                        this.stopRecording()
                        this.recordButton.textContent = '开始录制'
                        this.uploadButton.disabled = false
                    } else {
                        this.count--
                    }
                    
                }, 1000)
            } else {
                clearInterval(this.intervalId)
                
                this.duration = this.maxD - this.count
                this.count = this.maxD
                this.stopRecording()
                this.recordButton.textContent = '开始录制'
                this.uploadButton.disabled = false
            }
        }
        // 点击播放
        play() {
            const { recordedBlobs, gumVideo2 } = this
            const blob = new Blob(recordedBlobs, { type: 'video/mp4' })
            const size = parseInt(blob.size / 1024)
            let strSize = ''
            if (size < 1024) {
                strSize = size + 'KB'
            } else {
                strSize = (size/1024).toFixed(2) + 'MB'
            }
            alert('播放时长：' + this.duration + '秒, 大小：'+strSize)
            const videoURL = URL.createObjectURL(blob)
            gumVideo2.style.display = ''
            gumVideo2.src = videoURL
        
        }
        // 获取摄像头流媒体
        getUserMedia(constraints, success, error) {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                //最新的标准API
                navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error)
            } else if (navigator.webkitGetUserMedia) {
                //webkit核心浏览器
                navigator.webkitGetUserMedia(constraints, success, error)
            } else if (navigator.mozGetUserMedia) {
                //firfox浏览器
                navigator.mozGetUserMedia(constraints, success, error)
            } else if (navigator.getUserMedia) {
                //旧版API
                navigator.getUserMedia(constraints, success, error)
            }
        }
        // 摄像头流媒体成功回调
        handleSuccess(stream) {
            this.recordButton.disabled = false
            this.stream = stream
            this.gumVideo.srcObject = stream
        }
        // 摄像头流媒体失败回调
        handleError(error) {
            if (error.message === 'Permission denied') {
                alert('您已经禁止使用摄像头，请到设置-通用-微信存储空间-管理微信存储空间-点击‘清理其他微信账号聊天数据’')
            }
            console.log('navigator.getUserMedia error: ', error)
        }
        // 开始录制
        startRecording() {
            this.recordedBlobs = []
            const options = { 
                audioBitsPerSecond: 128000,
                videoBitsPerSecond: 2500000,
                mimeType: 'video/webm' 
            }
            try {
                this.mediaRecorder = new MediaRecorder(this.stream, options)
            } catch (e) {
                alert('MediaRecorder创建失败: ' + e + '. mimeType: ' + options.mimeType)
                return
            }
            this.recordButton.textContent = '结束录制'
            this.uploadButton.disabled = true
            this.mediaRecorder.onstop = e => this.handleStop(e)
            this.mediaRecorder.ondataavailable = e => this.handleDataAvailable(e)
            this.mediaRecorder.start(10);
        }
        // 录制中
        handleDataAvailable(event) {
            if (event.data && event.data.size > 0) {
                this.recordedBlobs.push(event.data)
            }
        }
        // 录制结束回调
        handleStop(event) {
            console.log('Recorder stopped: ', event)
        }
        // 停止录制
        stopRecording() {
            tEl.innerHTML = '录制完成'
            this.mediaRecorder.stop()
        }
    }
    new RecordingVideo()
    
</script>

</html>